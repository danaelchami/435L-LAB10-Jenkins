pipeline
{
    agent any
    environment
    { 
        VIRTUAL_ENV = 'venv'
        SYSTEM_PYTHON = 'C:\\Users\\user\\AppData\\Local\\Programs\\Python\\Python313\\python.exe'
        
    }

    stages
    { 
        stage('Setup')
        {
            steps {
                script {
                    if (!fileExists("${env.WORKSPACE}\\${VIRTUAL_ENV}")) {
                        bat "${SYSTEM_PYTHON} -m venv ${VIRTUAL_ENV}"
                    }
                    bat """
                    ${VIRTUAL_ENV}\\Scripts\\python.exe -m pip install --upgrade pip
                    ${VIRTUAL_ENV}\\Scripts\\pip.exe install flake8 pytest coverage bandit
                    ${VIRTUAL_ENV}\\Scripts\\pip.exe list
                    """
                }
            }
        }

        stage('Lint')
        { 
            steps {
                script {
                    bat "${VIRTUAL_ENV}\\Scripts\\python.exe -m flake8 app.py"
                }
            }
        }

        stage('Test')
        { 
            steps {
                script {
                    bat "${VIRTUAL_ENV}\\Scripts\\python.exe -m pytest"
                }
            }
        }

        stage('Coverage')
        { 
            steps {
                script {
                    bat """
                    ${VIRTUAL_ENV}\\Scripts\\python.exe -m coverage run -m pytest
                    ${VIRTUAL_ENV}\\Scripts\\python.exe -m coverage report -m
                    """
                }
            }
        }

       stage('Security Scan') {
            steps {
                script {
                    
                    def cmd = """
                        ${VIRTUAL_ENV}\\Scripts\\bandit -r . ^
                        --exclude venv,__pycache__,.pytest_cache,tests ^
                        --severity-level high ^
                        --confidence-level high ^
                        -f json -o bandit.json
                    """

                    
                    int status = bat(returnStatus: true, script: cmd)

                    archiveArtifacts artifacts: 'bandit.json', fingerprint: true

                    if (status == 0) {
                        echo 'Bandit: No security issues found.'
                    } else if (status == 1) {
                        unstable(' Bandit found security issues (see bandit.json).')
                    } else {
                        error(" Bandit failed (exit ${status}). Check configuration or environment.")
                    }
                }
            }
        }







        stage('Deploy')
        { 
            steps {
                script {
                    echo "Deploying application..."
                    bat """
                    echo Starting local deployment...
                    ${VIRTUAL_ENV}\\Scripts\\python.exe app.py
                    echo Application deployed locally on Jenkins host.
                    """
                }
            }
        }
    }

    post 
    {
        always
        { 
            cleanWs()
        }
    }
}
