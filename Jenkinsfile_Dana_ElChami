pipeline
{
    agent any
    environment
    { 
        VIRTUAL_ENV = 'venv'
        SYSTEM_PYTHON = 'C:\\Users\\user\\AppData\\Local\\Programs\\Python\\Python313\\python.exe'
        
    }

    stages
    { 
        stage('Setup')
        {
            steps {
                script {
                    if (!fileExists("${env.WORKSPACE}\\${VIRTUAL_ENV}")) {
                        bat "${SYSTEM_PYTHON} -m venv ${VIRTUAL_ENV}"
                    }
                    bat """
                    ${VIRTUAL_ENV}\\Scripts\\python.exe -m pip install --upgrade pip
                    ${VIRTUAL_ENV}\\Scripts\\pip.exe install flake8 pytest coverage bandit
                    ${VIRTUAL_ENV}\\Scripts\\pip.exe list
                    """
                }
            }
        }

        stage('Lint')
        { 
            steps {
                script {
                    bat "${VIRTUAL_ENV}\\Scripts\\python.exe -m flake8 app.py"
                }
            }
        }

        stage('Test')
        { 
            steps {
                script {
                    bat "${VIRTUAL_ENV}\\Scripts\\python.exe -m pytest"
                }
            }
        }

        stage('Coverage')
        { 
            steps {
                script {
                    bat """
                    ${VIRTUAL_ENV}\\Scripts\\python.exe -m coverage run -m pytest
                    ${VIRTUAL_ENV}\\Scripts\\python.exe -m coverage report -m
                    """
                }
            }
        }

       stage('Security Scan') {
            steps {
                script {
                    bat """
                        echo Copying only source files to temp folder...
                        mkdir temp_scan
                        copy app.py temp_scan\\
                        copy test_app.py temp_scan\\
                        copy requirements.txt temp_scan\\
                        
                        echo Running Bandit cleanly inside temp_scan...
                        cd temp_scan
                        ..\\${VIRTUAL_ENV}\\Scripts\\python.exe -m bandit -r . ^
                            --skip B101,B110,B307,B108 ^
                            -lll -f txt -o ..\\bandit_report.txt || exit 0
                        cd ..
                        echo ==== Bandit Report ====
                        type bandit_report.txt
                        rmdir /s /q temp_scan
                    """
                }
            }
        }





        stage('Deploy')
        { 
            steps {
                script {
                    echo "Deploying application..."
                    bat """
                    echo Starting local deployment...
                    ${VIRTUAL_ENV}\\Scripts\\python.exe app.py
                    echo Application deployed locally on Jenkins host.
                    """
                }
            }
        }
    }

    post 
    {
        always
        { 
            cleanWs()
        }
    }
}
